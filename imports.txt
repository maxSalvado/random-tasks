# vars
export REGION_PUB=us-east-1
export PUBLIC_REPO_NAME=monabot-api
export TAG="v$(date +%Y%m%d-%H%M)"

# isolated docker config (bypasses Windows cred helper)
mkdir -p ~/.docker-ecrpub
printf '{ "auths": {} }\n' > ~/.docker-ecrpub/config.json

# login to public ECR
DOCKER_CONFIG=~/.docker-ecrpub \
aws ecr-public get-login-password --region "$REGION_PUB" \
| DOCKER_CONFIG=~/.docker-ecrpub docker login --username AWS --password-stdin public.ecr.aws

# find your canonical repo URI
PUBLIC_REPO_URI=$(
  aws ecr-public describe-repositories --region "$REGION_PUB" \
  --repository-names "$PUBLIC_REPO_NAME" \
  --query 'repositories[0].repositoryUri' --output text
)

# build / tag / push
docker build -t "$PUBLIC_REPO_NAME:$TAG" .
docker tag   "$PUBLIC_REPO_NAME:$TAG" "$PUBLIC_REPO_URI:$TAG"
DOCKER_CONFIG=~/.docker-ecrpub docker push "$PUBLIC_REPO_URI:$TAG"

echo "Pushed: $PUBLIC_REPO_URI:$TAG"
